<!DOCTYPE html>
<html class="h-full antialiased" lang="en">

<head>
    <meta charSet="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Under the hood of Spark Shuffle Service</title>
    <meta name="description" content="Motivation
åœ¨ä½¿ç”¨äº†å»ºç«‹åœ¨ Yarn NodeManager ä¸Šçš„ Spark external shuffle service åï¼Œè™½ç„¶è§£å†³äº† Spark executor çš„å®¹é”™æ€§é—®é¢˜ï¼Œä½†æ˜¯å´å› ä¸ºå¤§é‡çš„å°æ–‡ä»¶éšæœºè¯»ï¼Œä½¿å¾—å•å° nodemanager çš„ disk io åˆ©ç”¨ç‡è¾¾åˆ° 100%ï¼" />
    <script src="/js/tailwindcss.js"></script>
</head>

<body class="flex h-full flex-col bg-zinc-50 dark:bg-black">
    <div id="__next">
        <div class="fixed inset-0 flex justify-center sm:px-8">
            <div class="flex w-full max-w-7xl lg:px-8">
                <div class="w-full bg-white ring-1 ring-zinc-100 dark:bg-zinc-900 dark:ring-zinc-300/20"></div>
            </div>
        </div>
        <div>
            <nav id="header">
    <div class="bg-gray-100">
        <header class="sticky top-0 z-30 w-full px-2 py-4 bg-white sm:px-4 shadow  dark:bg-slate-800">
            <div class="flex items-center justify-between mx-auto max-w-5xl">
                <a href="/">
                    <span class="text-2xl font-extrabold text-blue-600 dark:text-blue-200">show notes</span>
                </a>
                <div class="flex items-center space-x-1">
                    <ul class="hidden space-x-2 md:inline-flex">
                        <li><a href="/" class="px-4 py-2 font-semibold text-gray-600 rounded dark:text-white">Home</a></li>
                    </ul>
                    <div class="inline-flex md:hidden">
                        <button class="flex-none px-2 ">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24"
                                 stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16" />
                            </svg>
                            <span class="sr-only">Open Menu</span>
                        </button>
                        <!-- put list item -->
                    </div>
                </div>
            </div>
        </header>

    </div>
<!--    <div class="w-full flex items-center justify-between mt-0 px-6 py-2">-->
<!--       <div class="md:flex md:items-center md:w-auto w-full order-3 md:order-1" id="menu">-->
<!--          <nav >-->
<!--             <ul class="flex rounded-full bg-white/90 px-3 text-sm font-medium text-zinc-800 shadow-lg shadow-zinc-800/5 ring-1 ring-zinc-900/5 backdrop-blur dark:bg-zinc-800/90 dark:text-zinc-200 dark:ring-white/10">-->
<!--                <li><a class="relative block px-3 py-2 transition hover:text-teal-500 dark:hover:text-teal-400 item-menu" href="/">Home</a></li>-->
<!--             </ul>-->
<!--          </nav>-->
<!--       </div>-->
<!--       -->
<!--    </div>-->
 </nav>
        </div>
        <div class="relative">
            <main>
                <div class="sm:px-8 mt-6 lg:mt-6">
                    <div class="mx-auto max-w-6xl lg:px-8">
                        <div class="relative px-4 sm:px-8 lg:px-12">
                            <div class="mx-auto max-w-6xl lg:max-w-4xl">
                                <div class="xl:relative">
                                    <div class="mx-auto max-w-6xl">
                                        <article class="dark:text-white">
                                            <header class="flex flex-col">
                                                <h1
                                                    class="mt-6 text-4xl font-bold tracking-tight text-zinc-800 dark:text-zinc-100 sm:text-5xl">
                                                    Under the hood of Spark Shuffle Service</h1>
                                                <div class="flex w-full items-center justify-between pb-3 mt-6">
                                                    <div class="flex items-center space-x-3">
                                                        <div class="text-xs text-neutral-500">
                                                            2022-10-30</div>
                                                    </div>
                                                    <div class="flex items-center space-x-8">
                                                        
                                                    </div>
                                                </div>
                                            </header>
                                            <div class="mt-8">
                                                <div
                                                    class="d-block color-fg-default comment-body markdown-body js-comment-body">
                                                    <h2 dir="auto">Motivation</h2>
<p dir="auto">åœ¨ä½¿ç”¨äº†å»ºç«‹åœ¨ Yarn NodeManager ä¸Šçš„ Spark external shuffle service åï¼Œè™½ç„¶è§£å†³äº† Spark executor çš„å®¹é”™æ€§é—®é¢˜ï¼Œä½†æ˜¯å´å› ä¸ºå¤§é‡çš„å°æ–‡ä»¶éšæœºè¯»ï¼Œä½¿å¾—å•å° nodemanager çš„ disk io åˆ©ç”¨ç‡è¾¾åˆ° 100%ï¼Œä»è€Œå¯èƒ½å¯¼è‡´ executor ç«¯fetch shuffle data æ—¶å€™ï¼Œå‡ºç° fetch failed exceptionã€‚åœ¨æŸäº›æ³¢å³°æ—¶ï¼Œå¤§é‡ Spark ä»»åŠ¡å¤±è´¥</p>
<p dir="auto">å¦‚ä¸‹å›¾<br>
<a target="_blank" rel="noopener noreferrer nofollow" href="https://user-images.githubusercontent.com/8609142/170956304-3ed49fca-8ad8-490a-8b16-ec856283c634.png"><img src="https://user-images.githubusercontent.com/8609142/170956304-3ed49fca-8ad8-490a-8b16-ec856283c634.png" alt="image" style="max-width: 100%;"></a><br>
<a target="_blank" rel="noopener noreferrer nofollow" href="https://user-images.githubusercontent.com/8609142/170956314-86ee8029-4cfd-4c3e-97ab-94f8532fd169.png"><img src="https://user-images.githubusercontent.com/8609142/170956314-86ee8029-4cfd-4c3e-97ab-94f8532fd169.png" alt="image" style="max-width: 100%;"></a></p>
<p dir="auto">å¦å¤–åœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸‹ï¼Œå› ä¸ºåœ¨å¼•å…¥äº† elastic NodeManager on K8s, ä½¿å¾— external shuffle service åœ¨å¼¹æ€§ NM decommission ä¸‹çº¿æ—¶ï¼Œå¯èƒ½ä¼šå¯¹ä»»åŠ¡é€ æˆè¾ƒå¤§çš„æ³¢åŠ¨ï¼Œç‰¹åˆ«æ˜¯åœ¨å¼¹æ€§èŠ‚ç‚¹å æ®é›†ç¾¤ä¸­è¾ƒå¤§å®¹é‡æ—¶ã€‚</p>
<p dir="auto">åŸºäºä¸Šè¿°èƒŒæ™¯ï¼Œè®¡åˆ’æ·±å…¥ç ”ç©¶ spark external shuffle service å’Œåç»­çš„æ”¹è¿›æ–¹æ¡ˆï¼Œç”¨ä»¥å¢å¼º Spark åœ¨å¤§è§„æ¨¡åˆ†å¸ƒå¼è®¡ç®—ä¸‹çš„ç¨³å®šæ€§ã€‚</p>
<h2 dir="auto">é—®é¢˜ç‚¹</h2>
<p dir="auto">Shuffle ä½œä¸ºå½±å“åˆ†å¸ƒå¼è®¡ç®—ä¸‹å¤šèŠ‚ç‚¹æ•°æ®äº¤äº’çš„å…³é”®å› ç´ ï¼Œæ˜¯ä¸€ä¸ªçƒ­é—¨çš„ä¼˜åŒ–ç‚¹ï¼Œä¸»è¦ä»ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ç‚¹æ¥åš</p>
<blockquote>
<ol class="list-decimal list-outside" dir="auto">
<li>
<p dir="auto">ç£ç›˜çš„ç¢ç‰‡è¯»å†™ï¼ŒSpillå¤šæ¬¡å†™ç£ç›˜å’ŒReduceåªæ‹‰å–éƒ¨åˆ†Partitionæ•°æ®ï¼Œå½±å“æ•ˆç‡</p>
</li>
<li>
<p dir="auto">Reduce è¯»å–Mapç«¯æœ¬åœ°æ•°æ®ï¼Œéœ€è¦ MxR æ¬¡è¿œç¨‹ç½‘ç»œè¯»ï¼Œå½±å“ç¨³å®šæ€§</p>
</li>
<li>
<p dir="auto">å› ä¸º ESS çš„æ•°æ®å­˜å‚¨æœºåˆ¶ï¼Œå¯¼è‡´éšæœºè¯»æ”¾å¤§ï¼ŒDisk IO å®¹æ˜“è¢«æ‰“æ»¡</p>
</li>
</ol>
</blockquote>
<p dir="auto">ä¸‹æ–‡å°†æ­¤è¿™ä¸‰ä¸ªç‚¹ä½œä¸ºé—®é¢˜ï¼Œè´¯ç©¿æ–‡ç« ã€‚</p>
<h2 dir="auto">Spark external shuffle service åŸç† (version &lt; 3.2)</h2>
<p dir="auto">Spark ä¸ºäº†è§£å†³ executor åœ¨å®Œæˆ task åï¼Œèƒ½å¤Ÿé¡ºåˆ©é€€å‡ºã€‚å› æ­¤å¼•å…¥äº† external shuffle service çš„æœºåˆ¶ï¼Œä½¿å¾— shuffle data èƒ½å¤Ÿæ‰˜ç®¡äº ESSï¼Œexecutor çš„ç”Ÿå‘½å‘¨æœŸ &lt; shuffle dataã€‚ä¸»è¦æœ‰å¦‚ä¸‹å‡ ä¸ªæ­¥éª¤ï¼ˆmagnet è®ºæ–‡ä¸­å·²ç»æ¦‚æ‹¬ï¼‰<br>
<a target="_blank" rel="noopener noreferrer nofollow" href="https://user-images.githubusercontent.com/8609142/173027248-0e8ce165-3d52-4d0c-ac58-01ccb2877e02.png"><img src="https://user-images.githubusercontent.com/8609142/173027248-0e8ce165-3d52-4d0c-ac58-01ccb2877e02.png" alt="image" style="max-width: 100%;"></a></p>
<blockquote>
<ol class="list-decimal list-outside" dir="auto">
<li>
<p dir="auto">æ¯ä¸ª Spark executor ä¸€æ—¦å¯åŠ¨ï¼Œå°±ä¼šæ³¨å†Œåˆ° Yarn nodemanager ä¸Šçš„ external shuffle service ä¸Šã€‚è¿™ç§æ³¨å†Œæ–¹å¼ä½¿å¾— ess èƒ½å¤ŸçŸ¥é“ executor map ç‰©åŒ–çš„ shuffle æ•°æ®çš„ä½ç½®ã€‚è¯·æ³¨æ„ï¼ŒSpark ESS ä¸ä¸ Spark executor ç»‘å®šï¼Œå¹¶åœ¨å¤šä¸ª Spark app é—´å…±äº«</p>
</li>
<li>
<p dir="auto">shuffle map stage é˜¶æ®µä¸­çš„æ¯ä¸ªä»»åŠ¡éƒ½å¤„ç†å…¶æ•°æ®éƒ¨åˆ†ã€‚åœ¨ map ä»»åŠ¡ç»“æŸæ—¶ï¼Œå®ƒä¼šç”Ÿæˆä¸€å¯¹æ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯ shuffle data, å¦ä¸€ä¸ªæ˜¯ shuffle data çš„ç´¢å¼•æ–‡ä»¶ã€‚Map task å°†ä¼šé€šè¿‡ä½¿ç”¨ hash è¿‡ partition key æ¥æ’åºæ‰€æœ‰è½¬æ¢è¿‡çš„ recordã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œmap task å°†å†™å…¥ä¸´æ—¶æ•°æ®åˆ°ç£ç›˜ä¸Šï¼Œå¦‚æœå®ƒè¿˜æ²¡æœ‰æ’åºå®Œæˆã€‚ä¸€æ—¦æ’åºå®Œæˆï¼Œshuffle data file å°†ä¼šè¢«ç”Ÿæˆï¼Œå±äºåŒä¸€ä¸ªä¸‹æ¸¸ reduce partition çš„æ•°æ® records å°†ä¼šè¢«èšåˆåˆ°ä¸€ä¸ª shuffle block ä¸Šã€‚å¯¹åº”çš„è®°å½•ç€ block offset çš„ shuffle ç´¢å¼•æ–‡ä»¶ä¹Ÿå°†ä¼šä¸€åŒè¢«ç”Ÿæˆã€‚</p>
</li>
<li>
<p dir="auto">å½“ä¸‹ä¸€ä¸ª reduce çš„ stage å¼€å§‹è¿è¡Œæ—¶ï¼Œä»–ä»¬å°†ä¼šæŸ¥è¯¢ spark driver æ¥è·å–åˆ° input shuffle block. ä¸€æ—¦ä¿¡æ¯å¯ç”¨ï¼Œæ¯ä¸€ä¸ª reduce task å°†ä¼šå’Œå¯¹åº”çš„ spark ess å®ä¾‹å»ºç«‹è¿æ¥ï¼Œæ¥ fetch data. å¯¹äº ESSï¼Œ ä¸€æ—¦æ¥æ”¶åˆ°è¯·æ±‚ï¼Œå°†ä¼šé€šè¿‡ shuffle ç´¢å¼•æ–‡ä»¶æ¥å®šä½åˆ° offset, ç›´æ¥ skip åˆ°å¯¹åº”çš„ shuffle data block ä½ç½®ï¼Œä»ç£ç›˜ä¸Šè¯»å–ï¼Œå¹¶å‘å› reduce task.</p>
</li>
</ol>
</blockquote>
<p dir="auto">æŒ‰ç…§ Linkedin çš„æ—¶é—´æ¥çœ‹ï¼Œå­˜åœ¨ä¸¤ä¸ªé—®é¢˜</p>
<blockquote>
<ol class="list-decimal list-outside" dir="auto">
<li>éšæœºè¯»é€ æˆDisk IO å‹åŠ›è¿‡å¤§ï¼Œå…¶ä¸­å› ç´ åŒ…æ‹¬ small shuffle block å¤ªå¤šã€éšæœºè¯»</li>
<li>M*R çš„æ•°æ®è®¿é—®è¿æ¥ï¼Œé€ æˆä¸ç¨³å®š</li>
</ol>
</blockquote>
<p dir="auto">ä»æˆ‘ä»¬çš„å®è·µæ¥çœ‹ï¼Œä¹Ÿå­˜åœ¨ä¸Šè¿°é—®é¢˜ã€‚åŒæ—¶åœ¨å¼¹æ€§æ··éƒ¨åœºæ™¯ä¸‹ï¼ŒESS ä¹Ÿä¸é€‚ç”¨ã€‚</p>
<h2 dir="auto">Push-based shuffle service (Managet) åŸç†</h2>
<p dir="auto">Magnet ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œå¼•å…¥ä¸€ä¸ª push-based shuffle service. é€šè¿‡åœ¨ Map ä¾§å°†åŒä¸€ä¸ª partition çš„æ•°æ® push -&gt; reduce partition ä¸Šï¼Œè§£å†³äº† data locality + disk io æ•ˆç‡ä¸é«˜çš„é—®é¢˜ã€‚æ¶æ„å›¾å¦‚ä¸‹<br>
<a target="_blank" rel="noopener noreferrer nofollow" href="https://user-images.githubusercontent.com/8609142/173027970-1f2790f1-4671-43ee-93ec-3b47e447cb05.png"><img src="https://user-images.githubusercontent.com/8609142/173027970-1f2790f1-4671-43ee-93ec-3b47e447cb05.png" alt="image" style="max-width: 100%;"></a></p>
<p dir="auto">ä»ä¸€ä¸ªä¸‹æ¸¸ reduce partition ä¸Šçš„ magnet shuffle service çš„è§†è§’æ¥çœ‹ï¼Œé€šè¿‡å°†ä¸åŒ map ä¾§ push è¿‡æ¥çš„æ•°æ® merge åˆ°ä¸€èµ·ï¼Œå¯ä»¥ç›´æ¥è®© reduce task é¡ºåºè¯»å–ã€‚ä»è€Œå®ç° RSS å·ç§°çš„<strong>éšæœºè¯»</strong>è½¬æ¢ä¸º<strong>é¡ºåºè¯»</strong>ï¼Œé¡ºä¾¿è¿˜å®ç°äº†æ•°æ®æœ¬åœ°æ€§ã€‚</p>
<p dir="auto">è¿™ç§ push based çš„æ–¹å¼å’Œä¸‹è¿°çš„ RSS å®ç°æ˜¯å¼‚æ›²åŒå·¥çš„ï¼Œç®€å•ç‚¹è®²ï¼Œå…¶å®åœ¨ Spark ä¸Šå®ç° shuffle service, å¤§éƒ¨åˆ†éƒ½æ˜¯åœ¨ merge/compaction çš„æ“ä½œï¼Œæ–¹ä¾¿ reduce task ä¸€æ¬¡æ€§è¯»å–ã€‚è¿™ä¸€ç‚¹ä¼˜åŒ–ï¼Œæœ‰ç‚¹ç±»ä¼¼äº Spark æ—©æœŸå°† task äº§å‡ºçš„æ•°æ®åˆ†ä¸º partition-N ä»½ï¼Œä¼˜åŒ–ä¸ºä½¿ç”¨ sort-based mergeçš„æ“ä½œï¼Œé™ä½æœ¬åœ°çš„å°æ–‡ä»¶å­˜å‚¨ã€‚</p>
<p dir="auto">å‡ ä¸ªæ³¨æ„ç‚¹</p>
<ol class="list-decimal list-outside" dir="auto">
<li>Magnet çš„éƒ¨ç½²å’Œå½“å‰ ESS å…¼å®¹</li>
<li>Magnet çš„æ•°æ®å°†ä¼šå­˜å‚¨ä¸¤ä»½ï¼ˆå‡†ç¡®æ¥è¯´æ˜¯&lt;2ï¼‰ï¼Œä¸€ä»½åœ¨ shuffle write ç«¯ï¼ˆmapï¼‰ï¼Œä¸€ä»½åœ¨ shuffle read ç«¯ï¼ˆreduceï¼‰ã€‚å› æ­¤ç†è®ºä¸Šï¼Œä»»æ„ä¸€ç«¯ä¸¢å¤±æˆ–è€…ä¸å®Œæ•´ï¼Œéƒ½ä¸ä¼šé‡ç®—ã€‚ä½†åŠ å¤§äº†å­˜å‚¨é‡ï¼Œlinkedin é€šè¿‡ zstd å‹ç¼© shuffle data æ¥ä¼˜åŒ–, å®ç°åªå¢åŠ äº†ç™¾åˆ†ä¹‹30çš„å­˜å‚¨é‡</li>
<li>Magnet ä¸ºäº†è§£å†³éƒ¨åˆ† merge task ç¼“æ…¢å’Œæ•°æ®å€¾æ–œï¼Œéƒ½æœ‰è¶…æ—¶å–æ¶ˆéƒ¨åˆ† merge block çš„æ“ä½œ</li>
<li>Magnet å…¼å®¹ Dynamic Allocationï¼Œä¼˜åŒ–ä¸º executor æ„ŸçŸ¥é€‚åº” magnet location åˆ†é…çš„ç­–ç•¥</li>
</ol>
<blockquote>
<p dir="auto">Magnet ç›®å‰å·²ç»åˆå¹¶åˆ° Spark 3.1 ç‰ˆæœ¬ä¸­ï¼Œä¼˜ç‚¹æ˜¯è¿ç»´ç®€å•ï¼Œæ— éœ€ç»´æŠ¤é¢å¤–çš„æœåŠ¡ï¼›ç¼ºç‚¹æ˜¯æ— æ³•é€‚ç”¨äºå¼¹æ€§æ··éƒ¨çš„åœºæ™¯</p>
</blockquote>
<h2 dir="auto">Remote shuffle service</h2>
<h4 dir="auto">Tencent firestorm</h4>
<p dir="auto">Firestorm ç”±è…¾è®¯å¼€æºï¼Œé€šè¿‡ coordinator cluster + shuffle server cluster ä¸»è¦è¿™ä¸¤ä¸ªç»„ä»¶å®ç°ã€‚<br>
coordinator è´Ÿè´£é‡‡é›† shuffle server çš„çŠ¶æ€æ•°æ®ï¼Œå¹¶ä¸”ç»™ spark task åˆ†é…æ•°æ®å†™å…¥çš„ shuffle serverã€‚<br>
shuffle server è´Ÿè´£ä» spark executor ä¸Šæ¥æ”¶å†™å…¥æ•°æ®ï¼Œå¹¶ merge åè½ç›˜ã€‚</p>
<p dir="auto">ç›®å‰ firestorm æ”¯æŒ å†…å­˜+æœ¬åœ°ç£ç›˜ã€å†…å­˜+HDFSã€æœ¬åœ°ç£ç›˜ã€HDFS è¿™4ç§æ¨¡å¼ã€‚local disk only ä»ä»‹ç»ä¸Šçœ‹ï¼Œæ˜¯è…¾è®¯å†…éƒ¨å¹¿æ³›ä½¿ç”¨çš„ã€‚</p>
<p dir="auto">Firestorm éœ€è¦ç‹¬ç«‹éƒ¨ç½²æœåŠ¡ï¼Œä¸€èˆ¬å¯ä»¥ç›´æ¥éƒ¨ç½²åœ¨ç‰©ç†æœºçš„ NM ä¸Šã€‚æ¶æ„å›¾å¦‚ä¸‹<br>
<a target="_blank" rel="noopener noreferrer nofollow" href="https://user-images.githubusercontent.com/8609142/173517679-e8440fc8-427e-4e2a-90f8-4868b2258882.png"><img src="https://user-images.githubusercontent.com/8609142/173517679-e8440fc8-427e-4e2a-90f8-4868b2258882.png" alt="image" style="max-width: 100%;"></a></p>
<p dir="auto"><strong>Firestorm å†™å…¥æ•°æ®çš„æ­¥éª¤å¦‚ä¸‹</strong></p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer nofollow" href="https://user-images.githubusercontent.com/8609142/173517824-be1268fa-db57-42cc-a621-44cd7e3b2bee.png"><img src="https://user-images.githubusercontent.com/8609142/173517824-be1268fa-db57-42cc-a621-44cd7e3b2bee.png" alt="image" style="max-width: 100%;"></a></p>
<blockquote>
<ol class="list-decimal list-outside" dir="auto">
<li>
<p dir="auto">taskå°† record æ•°æ®å‘é€åˆ° buffer manager ä¸­</p>
</li>
<li>
<p dir="auto">å½“ buffer æ»¡äº†çš„æ—¶å€™ï¼Œåˆ·å†™ buffer æ•°æ®åˆ° executor ä¸Šçš„ data queue ä¸­</p>
</li>
<li>
<p dir="auto">ç»´æŠ¤ä¸€ä¸ª thread pool, å…ˆå‘è¿œç«¯ shuffle server è·å–åˆ°å¯ç”¨çš„å†…å­˜å—ã€‚è·å–æˆåŠŸåï¼Œå–ç”¨ queue ä¸­çš„æ•°æ®åè¿œç¨‹å†™å…¥åˆ° shuffle server ä¸­ã€‚</p>
</li>
<li>
<p dir="auto">shuffle server æ¥æ”¶åˆ°æ•°æ®åï¼Œå…ˆæ”¾ç½®åœ¨ memory ä¸­ï¼Œç­‰åˆ° buffer æ»¡äº†åï¼Œå†è¿›è¡Œè½ç›˜ã€‚è½ç›˜åˆ†åˆ«å†™ index file å’Œ data file.</p>
</li>
<li>
<p dir="auto">è½ç›˜åï¼Œtask ç»æ±‡æŠ¥æ‰€æœ‰çš„éœ€å†™å…¥çš„ blockid ç»™ shuffle serverã€‚shuffle server åŒæ­¥ç­‰å¾…è½ç›˜æˆåŠŸåï¼Œå†è¿”å›ã€‚è¿™ä¸€æ­¥ä¹Ÿä¼šå­˜å‚¨æ•°æ®å…ƒä¿¡æ¯åœ¨ shuffle server ä¾§ï¼Œæ–¹ä¾¿åç»­æ•°æ®æ ¡éªŒ</p>
</li>
</ol>
</blockquote>
<p dir="auto"><strong>Firestorm è¯»å–æ•°æ®æ­¥éª¤</strong></p>
<p dir="auto">å¦‚æœæ˜¯ shuffle server local diskï¼Œåˆ™ client å‘ shuffle server è¯»å–æ•°æ®ï¼›<br>
å¦‚æœæ˜¯å­˜å‚¨åˆ° HDFSï¼Œ åˆ™ client ä¸ç»è¿‡ shuffle server, ç›´æ¥ä¸ HDFS äº¤äº’è¯»å–æ•°æ®ã€‚</p>
<p dir="auto"><em>æœªæµ‹è¯•æ€§èƒ½ï¼Œä¸‹è¿°ä¸ºè…¾è®¯åˆ†äº«çš„æ€§èƒ½ä¼°ç®—</em></p>
<ol class="list-decimal list-outside" dir="auto">
<li>
<p dir="auto">shuffle data åªæœ‰å‡ åå…†çš„æƒ…å†µä¸‹ï¼Œæ€§èƒ½é™ä½ 15%</p>
</li>
<li>
<p dir="auto">shuffle data åœ¨æœ‰å‡ åGçš„æƒ…å†µä¸‹ï¼Œæ€§èƒ½æœ‰ 3-4 å€æå‡</p>
</li>
</ol>
<p dir="auto"><strong>å¼€æºåœ°å€</strong>: <a href="https://github.com/tencent/firestorm">https://github.com/tencent/firestorm</a></p>
<h4 dir="auto">Aliyun RSS</h4>
<p dir="auto">åŒæ ·é‡‡ç”¨çš„æ˜¯ master-slave æ¶æ„ï¼Œä»æ¶æ„ä»‹ç»ä¸Šæ¥çœ‹ï¼Œå¯¹äº worker èŠ‚ç‚¹çš„ç£ç›˜ç®¡æ§ã€æ»šåŠ¨å‡çº§åšäº†å¾ˆå¤šä¼˜åŒ–ã€‚ä¹Ÿæ˜¯æ”¯æŒæœ¬åœ°ç›˜å’Œ HDFS å­˜å‚¨ã€‚åŒæ—¶ shuffle æ•°æ®å­˜å‚¨åœ¨æœ¬åœ°ç›˜çš„æ—¶å€™ï¼Œæ”¯æŒåœ¨ worker ç«¯ replicationã€‚</p>
<p dir="auto">æ¶æ„å›¾å¦‚ä¸‹ï¼š<br>
<a target="_blank" rel="noopener noreferrer nofollow" href="https://user-images.githubusercontent.com/8609142/173988725-e782f801-a83e-48a9-9e60-ae4d27c9a9cb.png"><img src="https://user-images.githubusercontent.com/8609142/173988725-e782f801-a83e-48a9-9e60-ae4d27c9a9cb.png" alt="image" style="max-width: 100%;"></a></p>
<p dir="auto">shuffle ä¸»è¦è¿‡ç¨‹å¦‚ä¸‹</p>
<blockquote>
<ol class="list-decimal list-outside" dir="auto">
<li>Mapperåœ¨é¦–æ¬¡PushDataæ—¶è¯·æ±‚Masteråˆ†é…Workerèµ„æºï¼ŒWorkerè®°å½•è‡ªå·±æ‰€éœ€è¦æœåŠ¡çš„Partitionåˆ—è¡¨ã€‚</li>
<li>MapperæŠŠShuffleæ•°æ®ç¼“å­˜åˆ°å†…å­˜ï¼Œè¶…è¿‡é˜ˆå€¼æ—¶è§¦å‘Pushã€‚</li>
<li>éš¶å±åŒä¸ªPartitionçš„æ•°æ®è¢«Pushåˆ°åŒä¸€ä¸ªWorkeråšåˆå¹¶ï¼Œä¸»Workerå†…å­˜æ¥æ”¶åˆ°æ•°æ®åç«‹å³å‘ä»Workerå‘èµ·Replicationï¼Œæ•°æ®è¾¾æˆå†…å­˜ä¸¤å‰¯æœ¬åå³å‘Clientå‘é€ACKï¼ŒFlusheråå°çº¿ç¨‹è´Ÿè´£åˆ·ç›˜ã€‚</li>
<li>Mapper Stageè¿è¡Œç»“æŸï¼ŒMetaServiceå‘Workerå‘èµ·CommitFileså‘½ä»¤ï¼ŒæŠŠæ®‹ç•™åœ¨å†…å­˜çš„æ•°æ®å…¨éƒ¨åˆ·ç›˜å¹¶è¿”å›æ–‡ä»¶åˆ—è¡¨ã€‚</li>
<li>Reducerä»å¯¹åº”çš„æ–‡ä»¶åˆ—è¡¨ä¸­è¯»å–Shuffleæ•°æ®ã€‚</li>
</ol>
</blockquote>
<p dir="auto">æ•´ä½“æ¶æ„æ€è·¯å’Œ firestorm åŸºæœ¬éƒ½æ˜¯ä¸€è‡´çš„ï¼Œåªåœ¨äºè¯´æ€§èƒ½å¦‚ä½•ï¼Ÿ</p>
<p dir="auto"><strong>å¼€æºåœ°å€</strong> ï¼š<a href="https://github.com/alibaba/RemoteShuffleService">https://github.com/alibaba/RemoteShuffleService</a></p>
<h4 dir="auto">OPPO shuttle</h4>
<p dir="auto">oppo shuttle åªæ”¯æŒåˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿæ¥ä½œä¸º shuffle å­˜å‚¨ã€‚å› æ­¤æš‚ä¸åšè€ƒè™‘</p>
<p dir="auto"><strong>å¼€æºåœ°å€</strong> ï¼š<a href="https://github.com/oppo-bigdata/shuttle">https://github.com/oppo-bigdata/shuttle</a></p>
<h2 dir="auto">Reference</h2>
<ol class="list-decimal list-outside" dir="auto">
<li><a href="http://www.vldb.org/pvldb/vol13/p3382-shen.pdf" rel="nofollow">http://www.vldb.org/pvldb/vol13/p3382-shen.pdf</a></li>
<li><a href="https://engineering.linkedin.com/blog/2020/introducing-magnet" rel="nofollow">https://engineering.linkedin.com/blog/2020/introducing-magnet</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/443752106" rel="nofollow">https://zhuanlan.zhihu.com/p/443752106</a></li>
<li><a href="https://issues.apache.org/jira/browse/SPARK-30602" rel="nofollow">https://issues.apache.org/jira/browse/SPARK-30602</a></li>
<li><a href="https://www.bilibili.com/s/video/BV1Ah411x7ay" rel="nofollow">https://www.bilibili.com/s/video/BV1Ah411x7ay</a> (è…¾è®¯firestormä»‹ç»)</li>
<li><a href="https://mp.weixin.qq.com/s?src=11&amp;timestamp=1655350948&amp;ver=3863&amp;signature=NMeoi6khA16aDN-D0PZl6VInPk3O3xwv9h-V4rzXf8JCCw4L4rPlE1qECN-QJDJnN8vJgYfeehGqoXqd8hMMQ8k3DXZtuFVEwvCr9GcU8bZ-n5hpH1z4gJTUT1gudyrk&amp;new=1" rel="nofollow">Shuttleï¼šé«˜å¯ç”¨ é«˜æ€§èƒ½ Spark Remote Shuffle Service</a></li>
</ol>
                                                </div>
                                            </div>
                                        </article>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
            <div class="pt-10 pb-16">
                <script src="https://utteranc.es/client.js"
                        repo="zuston/zuston.github.io"
                        issue-term="pathname"
                        theme="github-light"
                        crossorigin="anonymous"
                        async>
                </script>
            </div>
            <footer>
    <div class="sm:px-8">
        <div class="mx-auto max-w-7xl lg:px-8">
            <div class="border-t border-zinc-100 pt-10 pb-16 dark:border-zinc-700/40">
                <div class="relative px-4 sm:px-8 lg:px-12">
                    <div class="mx-auto max-w-2xl lg:max-w-5xl">
                        <div class="flex flex-col items-center justify-between gap-6 sm:flex-row">
                            <div class="flex gap-6 text-sm font-medium text-zinc-800 dark:text-zinc-200">
                                <a class="transition hover:text-teal-500 dark:hover:text-teal-400" href="/">Home</a>
                                <p class="text-sm text-zinc-400 dark:text-zinc-500">Â©
                                    <!-- -->2023
                                    <!-- --> zuston. All rights reserved.
                                </p>
                                <p class="text-sm text-zinc-400 dark:text-zinc-500">
                                    Powered by <a href="https://github.com/zuston/lizi" class="text-gray-800 dark:text-white">lizi</a>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
</footer>
        </div>
    </div>
    <link rel="stylesheet" href="/css/color-modes.css">
    <link rel="stylesheet" href="/css/post.css">
    <link rel="stylesheet" href="/css/markdown.css">
    <link rel="stylesheet" href="/css/base.css">
</body>

</html>